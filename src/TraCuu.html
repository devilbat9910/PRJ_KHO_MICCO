<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding: 15px; font-size: 14px; }
    .form-row { margin-bottom: 1rem; }
    .btn { cursor: pointer; }
    #results-container { margin-top: 20px; }
    #status { margin-top: 15px; display: none; }
    th, td { text-align: left; padding: 8px; }
    tbody tr:hover { background-color: #f5f5f5; }
  </style>
</head>
<body data-mode="<?= (typeof mode !== 'undefined' ? mode : 'search') ?>">
  <h4>Tra Cứu Giao Dịch</h4>
  
   <div class="form-row">
    <div class="form-group col-md-6">
      <label for="searchIndex">INDEX (SKU)</label>
      <input type="text" class="form-control" id="searchIndex" placeholder="Ưu tiên tìm theo INDEX">
    </div>
    <div class="form-group col-md-6">
      <label for="searchLoSanXuat">Lô Sản Xuất</label>
      <input type="text" class="form-control" id="searchLoSanXuat">
    </div>
   </div>
   <div class="form-row">
      <div class="form-group col-md-12">
        <label for="searchTenSanPham">Tên Sản Phẩm</label>
        <select class="form-control" id="searchTenSanPham"><option value="" selected>-- Tất cả --</option></select>
      </div>
   </div>

  <button class="btn btn-primary btn-block" id="searchButton" onclick="performSearch()">Tìm Kiếm</button>
  
  <div id="status" class="alert"></div>

  <div id="results-container">
    <table class="table table-sm table-striped table-bordered" style="display: none;" id="resultsTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const isEditMode = document.body.dataset.mode === 'edit';

    document.addEventListener("DOMContentLoaded", function() {
      google.script.run
        .withSuccessHandler(data => {
          const productSelect = document.getElementById('searchTenSanPham');
          data.products.forEach(p => productSelect.add(new Option(p.text, p.value)));
        })
        .getDropdownData();
    });

    function performSearch() {
      const searchBtn = document.getElementById('searchButton');
      searchBtn.disabled = true;
      searchBtn.textContent = 'Đang tìm kiếm...';

      const searchCriteria = {
        index: document.getElementById('searchIndex').value.trim().toUpperCase(),
        loSanXuat: document.getElementById('searchLoSanXuat').value.trim(),
        tenSanPham: document.getElementById('searchTenSanPham').value
      };

      google.script.run
        .withSuccessHandler(displayResults)
        .withFailureHandler(handleSearchError)
        .logic_performSearch(searchCriteria);
    }

    function displayResults(response) {
      const searchBtn = document.getElementById('searchButton');
      const tableBody = document.getElementById('resultsTable').querySelector('tbody');
      tableBody.innerHTML = '';

      if (response.success && response.data.length > 0) {
        // simplified display for log search
        response.data.forEach(rowData => {
          let rowHtml = `<tr style="cursor: pointer;" onclick="handleRowClick('${rowData[1]}')">`; // rowData[1] is the SKU
          rowData.forEach(cell => rowHtml += `<td>${cell}</td>`);
          rowHtml += '</tr>';
          tableBody.innerHTML += rowHtml;
        });
        document.getElementById('resultsTable').style.display = 'table';
        showStatus(`Tìm thấy ${response.data.length} kết quả. Nhấp vào dòng để chọn.`, 'success');
      } else {
        showStatus(response.message || 'Không tìm thấy giao dịch.', 'warning');
      }
      searchBtn.disabled = false;
      searchBtn.textContent = 'Tìm Kiếm';
    }

    function handleSearchError(err) {
      showStatus('Lỗi: ' + err.message, 'danger');
      document.getElementById('searchButton').disabled = false;
      document.getElementById('searchButton').textContent = 'Tìm Kiếm';
    }

    function handleRowClick(indexValue) {
      if (!isEditMode || !indexValue) return;
      showStatus('Đang lấy dữ liệu để sửa...', 'info');
      google.script.run
        .withSuccessHandler(data => {
          google.script.run.withSuccessHandler(() => google.script.host.close()).passDataToOpener(data);
        })
        .withFailureHandler(handleSearchError)
        .getDataForEdit(indexValue);
    }
    
    function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'block';
        statusDiv.className = `alert alert-${type}`;
        statusDiv.textContent = message;
    }
  </script>
</body>
</html>