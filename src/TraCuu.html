<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding: 15px; font-size: 14px; }
    .form-row { margin-bottom: 1rem; }
    .btn { cursor: pointer; }
    #results-container { margin-top: 20px; }
    #status { margin-top: 15px; display: none; }
    th, td { text-align: left; padding: 8px; }
  </style>
</head>
<body>
  <h4>Tra Cứu Tồn Kho</h4>
  
   <div class="form-row">
    <div class="form-group col-md-12">
      <label for="searchIndex">INDEX (Ưu tiên cao nhất)</label>
      <input type="text" class="form-control" id="searchIndex" placeholder="Nhập INDEX để tìm chính xác, các bộ lọc khác sẽ bị bỏ qua">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="searchTenSanPham">Tên Sản Phẩm (hoặc một phần INDEX)</label>
      <input type="text" class="form-control" id="searchTenSanPham">
    </div>
    <div class="form-group col-md-6">
      <label for="searchLoSanXuat">Lô Sản Xuất</label>
      <input type="text" class="form-control" id="searchLoSanXuat">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="searchNgaySXStart">Từ Ngày Sản Xuất</label>
      <input type="date" class="form-control" id="searchNgaySXStart">
    </div>
    <div class="form-group col-md-6">
      <label for="searchNgaySXEnd">Đến Ngày Sản Xuất</label>
      <input type="date" class="form-control" id="searchNgaySXEnd">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="searchQuyCach">Quy Cách</label>
      <input type="text" class="form-control" id="searchQuyCach">
    </div>
    <div class="form-group col-md-6">
      <label for="searchQCStatus">Tình Trạng Chất Lượng</label>
      <select class="form-control" id="searchQCStatus">
        <option value="">Tất cả</option>
        <option>Đạt</option>
        <option>Chờ kết quả</option>
        <option>Mẫu lưu</option>
      </select>
    </div>
  </div>

  <button class="btn btn-primary btn-block" id="searchButton" onclick="performSearch()">Tìm Kiếm</button>
  
  <div id="status" class="alert"></div>

  <div id="results-container">
    <table class="table table-sm table-striped table-bordered" style="display: none;" id="resultsTable">
      <thead>
        <!-- Header sẽ được tạo động bởi script -->
      </thead>
      <tbody>
        <!-- Dữ liệu kết quả sẽ được chèn vào đây -->
      </tbody>
    </table>
  </div>

  <script>
    function performSearch() {
      const searchBtn = document.getElementById('searchButton');
      const statusDiv = document.getElementById('status');
      const resultsTable = document.getElementById('resultsTable');

      searchBtn.disabled = true;
      searchBtn.textContent = 'Đang tìm kiếm...';
      statusDiv.style.display = 'none';
      resultsTable.style.display = 'none';

      const searchIndexInput = document.getElementById('searchIndex');
      const searchCriteria = {
        index: searchIndexInput.value.toUpperCase(),
        tenSanPham: document.getElementById('searchTenSanPham').value,
        loSanXuat: document.getElementById('searchLoSanXuat').value,
        ngaySXStart: document.getElementById('searchNgaySXStart').value,
        ngaySXEnd: document.getElementById('searchNgaySXEnd').value,
        quyCach: document.getElementById('searchQuyCach').value,
        qcStatus: document.getElementById('searchQCStatus').value
      };
      
      // Tự động chuyển input thành chữ hoa
      searchIndexInput.value = searchCriteria.index;

      google.script.run
        .withSuccessHandler(displayResults)
        .withFailureHandler(handleSearchError)
        .logic_performSearch(searchCriteria);
    }

    function displayResults(response) {
      const searchBtn = document.getElementById('searchButton');
      const statusDiv = document.getElementById('status');
      const resultsTable = document.getElementById('resultsTable');
      const tableHead = resultsTable.querySelector('thead');
      const tableBody = resultsTable.querySelector('tbody');

      searchBtn.disabled = false;
      searchBtn.textContent = 'Tìm Kiếm';
      tableHead.innerHTML = '';
      tableBody.innerHTML = '';

      if (response.success && response.data.length > 0) {
        const data = response.data;
        const headers = response.headers;

        // Create table header
        let headerRow = '<tr>';
        headers.forEach(h => headerRow += `<th>${h}</th>`);
        headerRow += '</tr>';
        tableHead.innerHTML = headerRow;

        // Create table body
        data.forEach(rowData => {
          let row = '<tr>';
          rowData.forEach(cell => row += `<td>${cell}</td>`);
          row += '</tr>';
          tableBody.innerHTML += row;
        });

        resultsTable.style.display = 'table';
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-success';
        statusDiv.textContent = `Tìm thấy ${data.length} kết quả.`;

      } else {
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-warning';
        statusDiv.textContent = response.message || 'Không tìm thấy kết quả nào phù hợp.';
      }
    }

    function handleSearchError(err) {
      const searchBtn = document.getElementById('searchButton');
      const statusDiv = document.getElementById('status');
      
      searchBtn.disabled = false;
      searchBtn.textContent = 'Tìm Kiếm';

      statusDiv.style.display = 'block';
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Lỗi: ' + err.message;
    }
  </script>
</body>
</html>