<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding: 15px; font-size: 14px; }
    .form-group { margin-bottom: 1rem; }
    .btn { cursor: pointer; }
    #status { margin-top: 15px; display: none; }
  </style>
</head>
<body>
  <form id="inputForm">
    <div class="form-group">
      <label for="loaiGiaoDich">Loại Giao Dịch</label>
      <select class="form-control" id="loaiGiaoDich" onchange="handleTransactionTypeChange()">
        <option value="Nhập">Nhập</option>
        <option value="Xuất">Xuất</option>
        <option value="Điều chuyển">Điều chuyển</option>
      </select>
    </div>
    <div class="form-group">
      <label for="index">INDEX (SKU)</label>
      <input type="text" class="form-control" id="index" readonly onblur="fetchSkuDetails()">
    </div>
    <div class="form-group">
      <label for="tenSanPham">Tên Sản Phẩm</label>
      <select class="form-control" id="tenSanPham" required onchange="suggestLoSanXuat()"><option value="" disabled selected>Đang tải...</option></select>
    </div>
    <div class="form-group">
      <label for="quyCach">Quy cách (D32, B25...)</label>
      <input type="text" class="form-control" id="quyCach">
    </div>
    <div class="form-group">
      <label for="soLuong">Số Lượng</label>
      <input type="number" class="form-control" id="soLuong" min="0" required>
    </div>
     <div class="form-group">
      <label for="loSanXuat">Lô Sản Xuất (Gợi ý)</label>
      <input type="text" class="form-control" id="loSanXuat" placeholder="Điền Tên SP, Quy cách, Ngày SX để gợi ý">
    </div>
    <div class="form-group">
      <label for="ngaySanXuat">Ngày Sản Xuất</label>
      <input type="date" class="form-control" id="ngaySanXuat" onchange="suggestLoSanXuat()">
    </div>
    <div class="form-group">
      <label for="phanXuong">Đơn Vị Sản Xuất</label>
      <select class="form-control" id="phanXuong" onchange="suggestLoSanXuat()"><option value="" disabled selected>Đang tải...</option></select>
    </div>
    <div class="form-group">
      <label for="tinhTrangChatLuong">Tình Trạng Chất Lượng</label>
      <select class="form-control" id="tinhTrangChatLuong">
        <option>Đạt</option>
        <option>Chờ kết quả</option>
        <option>Mẫu lưu</option>
      </select>
    </div>
    <div class="form-group" id="kho-di-group" style="display: none;">
      <label for="khoDi">Kho Đi (Nguồn)</label>
      <select class="form-control" id="khoDi"><option value="" disabled selected>Đang tải...</option></select>
    </div>
    <div class="form-group">
      <label for="kho" id="kho-label">Kho</label>
      <select class="form-control" id="kho" required><option value="" disabled selected>Đang tải...</option></select>
    </div>
    <div class="form-group">
      <label for="ghiChu">Ghi Chú</label>
      <textarea class="form-control" id="ghiChu" rows="2"></textarea>
    </div>
    
    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-primary" style="flex-grow: 1; margin-right: 5px;" id="submitButton" onclick="submitForm()">Ghi Lại</button>
      <button type="button" class="btn btn-warning" style="flex-grow: 1; margin-left: 5px; margin-right: 5px;" id="editButton" onclick="loadForEdit()">Tra Cứu & Sửa</button>
      <button type="button" class="btn btn-secondary" style="flex-grow: 1; margin-left: 5px; margin-right: 5px;" id="processTableButton" onclick="processManualTable()">Xử lý Bảng</button>
      <button type="button" class="btn btn-info" style="flex-grow: 1; margin-left: 5px;" onclick="fillWithTestData()">TEST</button>
    </div>
    <div id="status" class="alert mt-3"></div>
  </form>

  <script>
    let allData = {};
    let originalTxData = null;

    document.addEventListener("DOMContentLoaded", function() {
      resetForm();
      google.script.run
        .withSuccessHandler(populateDropdowns)
        .withFailureHandler(handleDropdownError)
        .getDropdownData();
    });

    function resetForm() {
        document.getElementById('inputForm').reset();
        document.getElementById('ngaySanXuat').valueAsDate = new Date();
        originalTxData = null;
        document.getElementById('status').style.display = 'none';
        
        const submitBtn = document.getElementById('submitButton');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ghi Lại';
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-primary');
        
        handleTransactionTypeChange(); // Set initial form state
    }

    function populateDropdowns(data) {
      allData = data;
      populateSelect('tenSanPham', allData.products);
      populateSelect('phanXuong', allData.factories);
      populateSelect('kho', allData.warehouses);
      populateSelect('khoDi', allData.warehouses);
    }

    function handleDropdownError(err) {
      showStatus('Lỗi: ' + err.message, false);
    }

    function populateSelect(elementId, options) {
      const select = document.getElementById(elementId);
      if (!select) return;
      select.innerHTML = '<option value="" disabled selected>-- Chọn --</option>';
      options.forEach(function(option) {
        if (typeof option === 'object' && option !== null) {
          select.add(new Option(option.text, option.value));
        } else {
          select.add(new Option(option, option));
        }
      });
    }

    function submitForm() {
      const submitBtn = document.getElementById('submitButton');
      const isUpdate = originalTxData !== null;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Đang xử lý...';
      
      const formObject = {
        loaiGiaoDich: document.getElementById('loaiGiaoDich').value,
        index: document.getElementById('index').value,
        tenSanPham: document.getElementById('tenSanPham').value,
        quyCach: document.getElementById('quyCach').value,
        soLuong: document.getElementById('soLuong').value,
        loSanXuat: document.getElementById('loSanXuat').value,
        ngaySanXuat: document.getElementById('ngaySanXuat').value,
        tinhTrangChatLuong: document.getElementById('tinhTrangChatLuong').value,
        phanXuong: document.getElementById('phanXuong').value,
        kho: document.getElementById('kho').value,
        khoDi: document.getElementById('khoDi').value,
        ghiChu: document.getElementById('ghiChu').value,
      };

      if (!isUpdate && (!formObject.tenSanPham || !formObject.soLuong)) {
        showStatus('Vui lòng điền đầy đủ Tên Sản Phẩm và Số Lượng.', false);
        submitBtn.disabled = false; submitBtn.textContent = 'Ghi Lại'; return;
      }
      
      if (isUpdate && !formObject.index) {
        showStatus('Lỗi: Không tìm thấy INDEX của giao dịch gốc để cập nhật.', false);
        submitBtn.disabled = false; submitBtn.textContent = 'Cập Nhật'; return;
      }

      google.script.run.withSuccessHandler(function(response) {
        showStatus(response.message, response.success);
        if(response.success) { 
          resetForm(); 
        } else { 
          submitBtn.disabled = false; 
          submitBtn.textContent = isUpdate ? 'Cập Nhật' : 'Ghi Lại'; 
        }
      }).withFailureHandler(function(err) {
        showStatus('Lỗi: ' + err.message, false);
        submitBtn.disabled = false; 
        submitBtn.textContent = isUpdate ? 'Cập Nhật' : 'Ghi Lại';
      }).processFormData(formObject, isUpdate, originalTxData);
    }

    function showStatus(message, isSuccess) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = isSuccess ? 'alert alert-success mt-3' : 'alert alert-danger mt-3';
      statusDiv.style.display = 'block';
    }
    
    function loadForEdit() {
      google.script.run.showTraCuuDialogForEdit();
      setTimeout(startCheckingForData, 2000);
      showStatus('Đang mở dialog tra cứu...', 'info');
    }

    function startCheckingForData() {
      const intervalId = setInterval(function() {
        google.script.run
          .withSuccessHandler(function(data) {
            if (data) {
              clearInterval(intervalId);
              originalTxData = data;
              populateFormForEdit(data);
            }
          })
          .checkForEditData();
      }, 2000);
    }

    function populateFormForEdit(data) {
        document.getElementById('loaiGiaoDich').value = data.loaiGiaoDich;
        document.getElementById('index').value = data.sku;
        document.getElementById('tenSanPham').value = data.tenSanPham;
        document.getElementById('quyCach').value = data.quyCach;
        document.getElementById('soLuong').value = data.soLuong;
        document.getElementById('loSanXuat').value = data.loSanXuat;
        document.getElementById('ngaySanXuat').value = data.ngaySanXuat;
        document.getElementById('tinhTrangChatLuong').value = data.tinhTrangChatLuong;
        document.getElementById('phanXuong').value = data.phanXuong;
        document.getElementById('kho').value = data.kho;
        document.getElementById('ghiChu').value = data.ghiChu;
        
        const submitBtn = document.getElementById('submitButton');
        submitBtn.textContent = 'Cập Nhật';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-success');
        showStatus('Dữ liệu đã được tải. Sẵn sàng để cập nhật.', 'success');
    }
    
    function suggestLoSanXuat() {
      const productName = document.getElementById('tenSanPham').value;
      const factory = document.getElementById('phanXuong').value;
      const dateStr = document.getElementById('ngaySanXuat').value;

      if (productName && factory && dateStr) {
        google.script.run
          .withSuccessHandler(function(suggestedLot) {
            if (suggestedLot) {
              document.getElementById('loSanXuat').value = suggestedLot;
            }
          })
          .withFailureHandler(function(err) {
            console.error("Error suggesting lot number: " + err.message);
          })
          .suggestLotNumber(productName, factory, dateStr);
      }
    }

    function handleTransactionTypeChange() {
      const txType = document.getElementById('loaiGiaoDich').value;
      const indexInput = document.getElementById('index');
      const khoDiGroup = document.getElementById('kho-di-group');
      const khoLabel = document.getElementById('kho-label');
      const fieldsToToggle = ['tenSanPham', 'quyCach', 'loSanXuat', 'ngaySanXuat', 'phanXuong', 'tinhTrangChatLuong'];

      if (txType === 'Nhập') {
        indexInput.readOnly = true;
        indexInput.value = ''; // Clear index on import
        khoDiGroup.style.display = 'none';
        khoLabel.textContent = 'Kho Nhận';
        fieldsToToggle.forEach(id => document.getElementById(id).disabled = false);
      } else { // Xuất or Điều chuyển
        indexInput.readOnly = false;
        fieldsToToggle.forEach(id => document.getElementById(id).disabled = true);
        
        if (txType === 'Điều chuyển') {
          khoDiGroup.style.display = 'block';
          khoLabel.textContent = 'Kho Đến';
        } else { // Xuất
          khoDiGroup.style.display = 'none';
          khoLabel.textContent = 'Kho Xuất';
        }
      }
    }

    function fetchSkuDetails() {
      const indexInput = document.getElementById('index');
      const sku = indexInput.value.trim();
      if (!sku || indexInput.readOnly) return;
      
      showStatus('Đang tìm thông tin INDEX...', 'info');
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const data = response.data;
            
            document.getElementById('quyCach').value = data.Quy_Cách || '';
            document.getElementById('loSanXuat').value = data.Lô_SX || '';
            document.getElementById('ngaySanXuat').value = data.Ngày_SX || '';
            document.getElementById('tenSanPham').value = data.tenSanPham_fullName || '';
            document.getElementById('tinhTrangChatLuong').value = data.QC_Status || 'Đạt';
            document.getElementById('phanXuong').value = data.ĐV_SX || '';

            populateSelect('kho', response.validWarehouses || []);
            populateSelect('khoDi', response.validWarehouses || []);

            if (response.validWarehouses && response.validWarehouses.length > 0) {
                showStatus('Đã tìm thấy và điền thông tin. Vui lòng chọn kho và số lượng.', 'success');
            } else {
                showStatus('Đã tìm thấy INDEX, nhưng lô hàng này đã hết tồn kho.', 'warning');
            }
          } else {
            showStatus(response.message, false);
            // Reset warehouse dropdowns on failure
            populateSelect('kho', allData.warehouses || []);
            populateSelect('khoDi', allData.warehouses || []);
          }
        })
        .withFailureHandler(function(err) {
          showStatus('Lỗi khi lấy thông tin INDEX: ' + err.message, false);
        })
        .service_getSkuDetails(sku);
    }

    function processManualTable() {}
    function fillWithTestData() {}
  </script>
</body>
</html>
